---
titleTemplate: Linux Markdown
---
# 内存管理
内存管理的核心其实有两部分：
- 分页机制: 这部分**是理论部分**，偷懒不讲，可以百度一下。
- 内存池: 内存池等到网络编程时是个重点。

**所以part11东西其实很少，比较空。**

## 现代计算机的存储结构
![alt text](现代计算机的存储结构.png)
首先解释一下这张图，计算机的存储设备可以按照存储容量的从大到小，速度从慢到快，单位存储价格从低到高分为网络（可以认为存储数量无限），磁盘，磁盘缓存，物理内存（主存），高速缓存，寄存器。其中寄存器在cpu内部，其它的都在cpu外部。

其实大家可以这么理解 主要存储就三个 寄存器 物理内存 磁盘

#### 寄存器：
Cpu只能直接使用寄存器中的数据，任何数据都必须要传递到寄存器中才可以使用。

寄存器体积非常小，对于32位系统来说，有32bit，对于64位系统来说，有64bit。
从数量上来说，寄存器也很少，也就十几个。

#### 高速缓存
在早期的计算机，是没有高速缓存这个概念的，后来被引入，以提高主存和寄存器的交换速度。

高速缓存的工作原理大家不需要理解，只要知道有这么个概念就可以了。

#### 主存
一般我们说主存的概念，有两种，如图所示。这里所说的主存，其实就是物理内存

程序的主要过程都在内存上体现。这里讲一下物理内存和虚拟内存的概念，物理内存就是我们使用的内存条，但是用户在开发程序时是以进程为单位的，如果直接使用物理内存会非常困难，所以发明了虚拟内存的概念。在32位的系统中，每个进程都会有一个4g的虚拟内存，我们直接操作4g的虚拟内存，然后cpu的MMU模块会将虚拟内存映射到物理内存上。

内存上的内容在系统关闭时会清空，只有写到磁盘上才可以长久存储
#### 磁盘缓存
提高磁盘与主存的交互速度。
#### 磁盘
磁盘是计算机长期存储的主要设备，比如文件就写在磁盘上。
#### 可移动存储介质
网络不必说，需要数据时从网络获取就可以了。

# 虚拟内存
#### 早期的内存分配机制
在早期的计算机中，要运行一个程序，需要把内存全部加载到物理内存。

这样的物理内存分配方式看上去很合理，但实际上在分配策略方面有很多问题。

在物理内存的分配方面，曾经有非常多的算法，但始终没有一个算法可以很好的解决物理内存的分配问题。

直到虚拟内存诞生。

#### 进程的虚拟内存
每个进程都有一套虚拟内存地址，用来给自己的进程空间编号。然后这个虚拟内存，再通过CPU的MMU模块投射到物理内存上。

这就是虚拟内存的伟大之处 我们再也不需要怎么在物理内存上分配内存了 只需要投射一下就可以了


#### 重新考虑虚拟内存究竟有什么

##### 用户区，在32位linux系统中，占3g。

- 栈区：进程函数需要在栈上运行
</br>
- 代码区：进程运行所需要的代码就存储在这个区域
</br>
- 动态库加载区：在进程启动时加载必要的动态库
</br>
- 静态变量区和全局变量区：实际上这个区是我上一课为了简化模型而这么讲的，实际上这个区还可以分为两部分。
  - bss区：用来存储未初始化的全局变量，所以未初始化的全局变量均为0.
  - 数据区：存储已经初始化的全局变量和静态变量。对于静态变量来说，未初始化只会有个未定义的初值
</br>
- 环境变量区与命令行参数区：存储进程的环境变量与命令行参数。
</br>
- 堆区：堆区可以认为最特殊的区域，其它区域在进程启动时就已经被划分，而堆区只有在进程需要时才会分配。所以堆区又名动态运行区，是程序运行的主要区域。堆区的大小也是不固定的，理论上，只要用户区使用的区域没有达到3g，就仍然可以申请堆区。
